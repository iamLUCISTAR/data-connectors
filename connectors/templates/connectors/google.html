<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <script>
        // Function to start Google authentication
        async function startGoogleAuth() {
            try {
                let response = await fetch("{% url 'google-auth' %}", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                });

                if (!response.ok) {
                    throw new Error("Failed to get authentication URL");
                }

                let data = await response.json();
                let authUrl = data.auth_url;

                // Redirect to Google authentication page
                window.location.href = authUrl;

            } catch (error) {
                console.error("Error:", error);
                alert("Failed to start Google authentication.");
            }
        }

        // Function to fetch the list of Google Sheets from the backend
        async function fetchSheets() {
            try {
                let response = await fetch("{% url 'google-sheets' %}");
                let data = await response.json();

                if (data.sheets) {
                    let dropdown = document.getElementById("sheets-dropdown");
                    dropdown.innerHTML = "";  // Clear previous options

                    // Add a default option
                    let defaultOption = document.createElement("option");
                    defaultOption.textContent = "Select a Sheet";
                    dropdown.appendChild(defaultOption);

                    // Populate the dropdown with sheets data
                    data.sheets.forEach(sheet => {
                        let option = document.createElement("option");
                        option.value = sheet.sheet_id;
                        option.textContent = sheet.title;
                        dropdown.appendChild(option);
                    });

                    // Show the dropdown and fetch button
                    dropdown.style.display = "block";
                    document.getElementById("fetch-data-btn").style.display = "block";
                } else {
                    alert("No sheets found.");
                }
            } catch (error) {
                console.error("Error fetching sheets:", error);
            }
        }

        // Function to fetch data from the selected sheet
        async function fetchSheetData() {
            let sheetId = document.getElementById("sheets-dropdown").value;
            if (!sheetId) {
                alert("Please select a sheet first.");
                return;
            }

            try {
                let response = await fetch(`{% url 'google-sheet-data' %}?spreadsheet_id=${sheetId}`);
                let data = await response.json();

                if (data.data) {
                    let sheetDataDiv = document.getElementById("sheet-data");
                    sheetDataDiv.innerHTML = "";  // Clear previous data

                    // Display the fetched data
                    data.data.forEach(row => {
                        let rowDiv = document.createElement("div");
                        rowDiv.textContent = row.join(", ");
                        sheetDataDiv.appendChild(rowDiv);
                    });
                } else {
                    alert("No data found in the selected sheet.");
                }
            } catch (error) {
                console.error("Error fetching sheet data:", error);
            }
        }
    </script>
</head>
<body>
    <h1>Welcome, {{ user.username }}!</h1>

    <!-- Display success or error messages -->
    {% if messages %}
        <div id="messages">
            {% for message in messages %}
                <p style="color: {% if message.tags == 'success' %}green{% else %}red{% endif %};">
                    {{ message }}
                </p>
            {% endfor %}
        </div>
    {% endif %}

    <h2>Your Google Sheets:</h2>

    {% if user.google_access_token %}
        <!-- Show Fetch Sheets Button if authenticated -->
        <button onclick="fetchSheets()">Fetch Sheets</button>
    {% else %}
        <!-- Show Link Google Account Button if not authenticated -->
        <button onclick="startGoogleAuth()">Link Google Account</button>
    {% endif %}

    <!-- Dropdown to select a sheet (Initially hidden) -->
    <select id="sheets-dropdown" style="display: none;" onchange="fetchSheetData()">
        <option>Select a sheet</option>
    </select>

    <!-- Button to fetch data from the selected sheet -->
    <button id="fetch-data-btn" style="display: none;" onclick="fetchSheetData()">Fetch Data</button>

    <!-- Logout Form -->
    <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

    <div id="sheet-data"></div> <!-- Placeholder for showing fetched sheet data -->
</body>
</html>